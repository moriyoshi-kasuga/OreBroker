# 🎮 鉱物株取引ゲーム — 市場システム設計書（小刻み変動＋天変地異）

## 1. 概要

本システムは、Minecraftプラグイン上で動作する鉱物価格変動エンジンです。  
全鉱石の価格は基本的に現在価格から**小刻みに増減**し、大きな価格変動は**天変地異**や**石炭の革命**など特別イベントでのみ発生します。

---

## 2. 基本仕様

### 2.1 更新タイミング

- 価格は**2秒ごと**に全鉱石一括更新
- 更新は「通常変動」→「特殊イベント適用」の順で実行

### 2.2 変動方式

#### 通常時

- 現在価格 `P_t` から ±`stepMin`〜`stepMax` の範囲で整数ステップ変動
- 方向（上げ/下げ）は μ（平均価格帯中心）に戻る確率バイアスで決定  
  - μより下 → 上昇確率を高く  
  - μより上 → 下落確率を高く  
  - バイアス強度は `tilt` パラメータで調整
- **大きなジャンプは発生しない**

#### 天変地異時

- 対象鉱石の価格に倍率 `M` を適用（例：0.6〜1.4）
- 一度に大きく上下する唯一の要因
- 発生時は全プレイヤーに通知

---

## 3. イベント仕様

### 3.1 天変地異

- 発生確率：平均 80〜120秒に1回（2秒更新換算で確率調整）
- 継続時間：10秒（2秒更新×5回）
- 対象鉱石：全種 or ランダム2種
- 倍率範囲：`DISASTER_MIN`〜`DISASTER_MAX`（推奨：0.6〜1.4）
- 効果終了時に通知

### 3.2 石炭の革命

- 対象：石炭のみ
- 発生確率：0.04%/更新
- 効果：直前価格の×1.5〜3.0倍（上限は `pMax` と直前価格×5の小さい方）
- 発生後、石炭売買に3秒間のクールダウンを全員に付与
- 発生時に全プレイヤーへ通知

---

## 4. 鉱石ごとのパラメータ

| 鉱石 | pMin〜pMax | μ | tilt | stepMin | stepMax | 停滞時 stepMin | 停滞時 stepMax | 備考 |
|---|---:|---:|---:|---:|---:|---:|---:|---|
| ダイヤ | 250〜900 | 625 | 0.30 | 3 | 12 | 3 | 12 | 高値帯・戻り中程度 |
| エメラルド | 150〜750 | 625 | 0.32 | 2 | 10 | 2 | 10 | 高値帯・安定寄り |
| アメジスト | 10〜600 | 305 | 0.15 | 4 | 20 | 4 | 20 | 超ボラ |
| ラピス | 50〜500 | 225 | 0.35 | 2 | 10 | 2 | 10 | 強回帰 |
| レッドストーン | 25〜500 | 200 | 0.28 | 3 | 14 | 1 | 3 | モード切替あり |
| 金 | 45〜200 | 88 | 0.30 | 2 | 6 | 2 | 6 | 小ボラ |
| 鉄 | 25〜100 | 48 | 0.35 | 1 | 4 | 1 | 4 | 安定枠 |
| 銅 | 10〜75 | 35 | 0.30 | 1 | 5 | 1 | 5 | 安定枠 |
| 石炭 | 5〜100 | 30 | 0.25 | 1 | 6 | 1 | 6 | 革命イベントあり |

---

## 5. レッドストーンのモード切替

- 通常モード：`stepMin/Max` を使用
- 停滞モード：`stepMinStagnant/stepMaxStagnant` を使用
- 移行確率：20%/更新
- 停滞モード継続：10更新（20秒）

---

## 6. 売買ルール

- **採掘（買い）**：現時点価格×数量を支払い、鉱石取得  
  - 所持金不足時は掘れない
- **売却**：現時点価格×数量×(1−手数料) を受け取り  
  - 手数料：推奨 1% (`fee = 0.01`)
- 売買インパクト：
  - 売り後：価格を `SELL_IMPACT` 分下げ（推奨 0.006）
  - 買い後：価格を `BUY_IMPACT` 分上げ（推奨 0.001）
- 同鉱石売買クールダウン：1〜2秒（天変地異・革命時は追加）

---

## 7. 更新フロー

1. **モード更新**（レッドストーン）
2. **通常変動計算**
   - μとの距離から上昇確率 `probUp` を算出
   - ステップ幅をランダムに決定（停滞時は小幅）
   - 上げ/下げ方向を決定して価格更新
3. **石炭革命判定**
4. **天変地異適用**
5. **価格の丸め・範囲クランプ**
6. **売買インパクト反映**
7. **通知処理**

---

## 8. 設計意図

- **通常時は安定感のある小刻みな相場**を維持  
- 戦略性は鉱石ごとの `tilt`・`step幅` の違いで表現  
- **リスクイベント（天変地異・革命）**で一発逆転や急落が発生し、緊張感を持たせる  
- 全体的に長期期待値はほぼゼロになるよう設計し、特定鉱石が常勝にならないよう配慮
